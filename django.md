Django 基础教程
Tango with Django
Leif Azzopardi & David Maxwell 著
安道 译
rev 0.0.1, 2018-03-12T20:09:04+08:00❍ 目录
第 1 章 导言 .................................................................................................................................. 1
1.1 本书特色 1
1.2 你将学到 2
1.3 用到的技术和服务 3
1.4 Rango 的初步设计和客户要求 3
1.5 小结 8
第 2 章 前期准备工作.................................................................................................................. 11
2.1 Python 11
2.2 Python 包管理器 12
2.3 虚拟环境 13
2.4 集成开发环境 13
2.5 代码仓库 14
第 3 章 Django 基础.................................................................................................................... 15
3.1 检查环境 15
3.2 创建 Django 项目 16
3.3 创建 Django 应用 19
3.4 编写视图 20
3.5 映射 URL 22
3.6 基本流程 24
第 4 章 模板和媒体文件 .............................................................................................................. 27
4.1 使用模板 27
4.2 伺服静态文件 32
4.3 伺服媒体文件 38
4.4 基本流程 40
v第 5 章 模型与数据库.................................................................................................................. 43
5.1 Rango 的要求 43
5.2 设置数据库 44
5.3 创建模型 45
5.4 创建和迁移数据库 47
5.5 Django 模型和 shell 49
5.6 配置管理界面 50
5.7 编写一个填充脚本 53
5.8 基本流程 58
第 6 章 模型、模板和视图........................................................................................................... 63
6.1 创建数据驱动页面的流程 63
6.2 在首页显示分类 63
6.3 创建详情页面 66
第 7 章 表单 ................................................................................................................................ 79
7.1 基本流程 79
7.2 网页和分类表单 80
第 8 章 模板进阶......................................................................................................................... 91
8.1 使用相对 URL 91
8.2 去除重复 93
8.3 模板继承 96
8.4 render() 函数和 request 上下文 98
8.5 自定义模板标签 98
8.6 小结 101
第 9 章 用户身份验证................................................................................................................ 103
9.1 设置身份验证 103
9.2 密码哈希 104
9.3 密码验证器 105
9.4 User 模型 105
vi - 目录9.5 增加用户属性 106
9.6 创建用户注册视图和模板 108
9.7 实现登录功能 114
9.8 限制访问 119
9.9 退出 120
9.10 扩展功能 121
第 10 章 cookie 和会话 ............................................................................................................. 123
10.1 cookie 无处不在 123
10.2 会话和无状态协议 125
10.3 在 Django 中设置会话 126
10.4 测试是否支持 cookie 127
10.5 客户端 cookie：访问次数统计示例 128
10.6 会话数据 130
10.7 浏览器存续期会话和持久会话 132
10.8 清理会话数据库 133
10.9 注意事项和基本流程 133
第 11 章 使用 Django-Registration-Redux................................................................................ 135
11.1 安装和设置 135
11.2 各项操作的 URL 映射 136
11.3 创建模板 137
第 12 章 集成 Bootstrap............................................................................................................ 141
12.1 模板 142
12.2 调整模板 145
12.3 使用 Django-Bootstrap-Toolkit 153
12.4 接下来 154
第 13 章 Webhose 搜索............................................................................................................ 155
13.1 Webhose API 155
13.2 添加搜索功能 157
目录 - vii13.3 集成到 Rango 应用中 164
第 14 章 中期练习..................................................................................................................... 169
14.1 记录网页的访问次数 170
14.2 在分类页面中搜索 171
14.3 增加个人资料页面 171
第 15 章 jQuery 和 Django........................................................................................................ 173
15.1 在 Django 项目/应用中使用 jQuery 173
15.2 示例：操纵 DOM 176
第 16 章 使用 jQuery 处理 Ajax 请求 ........................................................................................ 177
16.1 通过 Ajax 实现的功能 177
16.2 添加点赞按钮 178
16.3 添加行内分类建议 180
第 17 章 自动化测试 ................................................................................................................. 187
17.1 运行测试 188
17.2 测试模型 188
17.3 测试视图 190
17.4 测试渲染的页面 191
17.5 测试覆盖度 191
第 18 章 部署 Django 项目 ....................................................................................................... 195
18.1 注册 PythonAnywhere 账户 195
18.2 PythonAnywhere 的 Web 界面 195
18.3 搭建虚拟环境 196
18.4 设置 Web 应用 199
18.5 ǿ志文件 203
第 19 章 结语 ............................................................................................................................ 205
附录 A 设置系统........................................................................................................................ 207
附录 B 中期练习参考解答 ......................................................................................................... 215
viii - 目录
图灵社区会员 骆昊(jackfrued@126.com) 专享 尊重版权本书是《Tango with Django》的简体中文版，由 Leif Azzopardi 和 David Maxwell 授权翻译。
© 版权所有，侵权必究。广告
进阶读物
《精通 Django》
购买电子书1
这一本学做结合的指南，Ȃ在教你使用 Django 和 Python 做 Web 开发。本书主要针对学生，因此
会详解使用 Django 开发 Web 应用过程中的每个步骤。
Django 官方提供了一份教程，而且网上也有很多优秀的教程，本书的目标是填补一些空白，通过
实例开发学习 Django 框架。此外，本书还会介绍开发 Web 应用所需掌握的其他知识，例如
HTML、 CSS、 JavaScript 等等。
1.1 本书特色
❏ 事半功倍
笔者见过很多聪明的学生陷入僵局，浪费几小时的时间尝试解决遇到的 Django 或其他 Web 开发
问题。这些问题往往是由于抓不住重点，或者所用的材料言语不详。有时，你可能灵光一现，在
十几分钟之内解决问题，但是更多的时候要耗费几小时。笔者结合自己的经验，力求消除这些障
碍，让你远离坎坷，在开发应用的过程中一帆风顺。
❏ 平缓学习曲线
Web 应用框架省时省力，但前提是你知道怎么使用框架。框架的学习曲线往往陡峭。本书力求平
缓学习曲线，详解方方面面，让你快速掌握框架的用法。
❏ 改进工作流程
使用 Web 应用框架要遵守特定的设计模式，你只需在特定的位置放置特定的代码。但是，与很多
学生交流之后，笔者发现他们经常抱怨，不知如何从框架那里夺回控制权（即控制反转）。为
此，笔者制定了几个工作流程，帮你在开发过程中重获控制权，以自己的方式构建 Web 应用。
❏ 边学边做
无论如何，不要只是看看内容而已。这是一本实作指南，你要自己动手使用 Django 构建 Web 应
用。动眼不动手可不行！若想有所获益，请跟着本书一起开发应用。而且，在开发的过程中，不
导言
1要复制粘贴书中的代码。自己动手输入，想想代码的作用，然后再阅读书中给出的说明。如果依
ȁ不解，查阅 Django 文档，到 Stack Overflow 或其他网站中寻求帮助，一定要把不理解的地方弄
明白。如果你确实陷入僵局了，可以联系笔者，以便笔者改进内容——已经有多位读者为本书做
出了贡献。
1.2 你将学到
本书以一个示例为主线，说明如何开发一个名为 Rango 的 Web 应用。在这个过程中将讲解如何完
成下述关键任务：
❏ 搭建开发环境，包含学习使用终端、虚拟环境、 pip 安装程序和 Git，等等。
❏ 创建 Django 项目和简单的 Django 应用。
❏ 配置 Django 项目，伺服静态媒体和其他媒体文件。
❏ 使用 Django 的“模型-视图-模板”设计模式。
❏ 创建数据库模型，使用 Django 提供的对象关系映射（Object Relational Mapping， ORM）
功能。
❏ 创建表单，利用数据库模型生成动态网页。
❏ 使用 Django 提供的用户身份验证服务。
❏ 在 Django 应用中融合外部服务。
❏ 在 Web 应用中引入层叠样式表（Cascading Styling Sheet， CSS）和 JavaScript。
❏ 使用 CSS 为应用提供专业的外观。
❏ 在 Django 应用中处理 cookie 和会话。
❏ 在应用中使用 Ajax 等高级技术。
❏ 把应用部署到 PythonAnywhere 上。
每一章结尾都有几道练习题，Ȃ在加强你对知识的掌握，也检验你能不能学以致用。后面几章还
有开放性开发练习，而且提供了参考代码和说明。
2 - 第 1 章 导言</> 这样的区域是练习
每一章都有练习题，Ȃ在检查你对知识和技能的掌握情况。你必须解答这些练习，因为后面
的章节建立在这些题目之上。
别担心自己做不出来，本书的 GitHub 仓库中有所有练习题的解答。
1.3 用到的技术和服务
本书将使用的技术和外部服务如下：
❏ Python 编程语言
❏ pip 包管理器
❏ Django 框架
❏ Git 版本控制器系统
❏ GitHub
❏ HTML
❏ CSS
❏ JavaScript 编程语言
❏ jQuery 库
❏ Twitter Bootstrap 框架
❏ Webhose API（即后文所用的搜索 API）
❏ PythonAnywhere 托管服务
这些技术和服务是笔者精选的，其中某些是 Web 开发的基础。 Twitter Bootstrap 为 Web 应用提供
样式， Webhose API 是一个外部服务， PythonAnywhere 则能简化部署应用的过程。
1.4 Rango 的初步设计和客户要求
本书的主线是开发一个名为 Rango 的应用。在这个过程中，我们将涵盖构建 Web 应用所需掌握的
重要知识。如果想查看这个应用的最终版本，请访问 http://rangodemo.pythonanywhere.com/rango/。
设计概要
客户要求你开发一个名为 Rango 的网站，让用户按分类浏览不同的网页。在西班牙语中， “rango”
的意思是“等级”或“显要地位”。
❏ 用户访问 Rango 网站的首页时，客户想让访客看到：
1.3 用到的技术和服务 - 3• 访问次数最多的 5 个网页
• 查看次数最多的 5 个分类
• 浏览或搜索分类的不同方式
❏ 用户访问分类页面时，客户想让 Rango 显示：
• 分类的名称、查看次数、点赞次数，以及分类下的网页（显示网页的标题，并链接到网
页的 URL）
• 一定的搜索功能（通过搜索 API 实现），找出可以归入当前分类的网页
❏ 客户要求记录分类的名称，分类页面被查看的次数，以及多少用户点击了“点赞”按钮（即
用户对分类打分，投票排名）。
❏ 各分类能通过友好的 URL 访问，例如 /rango/books-about-django/。
❏ 只有注册用户能搜索，能把网页添加到分类中。因此要让网站的访客能注册账户。
这么一看，我们要开发的应用并不复杂，不过是列出一些网页的分类而已。然而，这其中有些复
杂问题需要解决，可能并不像想的那样简单。着手开发之前，我们先规划一下整体设计。
</> 练习
继续阅读之前，请根据客户要求绘制下述设计图：
❏ N 层或系统架构图
❏ 主页和分类页面的线框图
❏ 应用的 URL 映射
❏ 实体关系图（Entity-Relationship diagram， ER 图），描述要实现的数据模式
在继续阅读之前，请试着完成这几题。即使你不熟悉系统架构图、线框图或 ER 图也没关
系，这几题的重点是让你思考如何说明和描述即将构建的应用。
N 层架构
多数 Web 应用的整体架构是一种 3 层结构。 Rango 也采用这种架构，不过稍有不同，因为它还要
4 - 第 1 章 导言
图灵社区会员 骆昊(jackfrued@126.com) 专享 尊重版权与外部服务交互。
图 1-1： Rango 的 3 层系统架构
因为我们将使用 Django 构建这个 Web 应用，所以各层用到的技术如下：
❏ 客户端是 Web 浏览器（例如 Chrome、 Firefox 或 Safari），负责渲染 HTML/CSS 页面。
❏ 中间件是一个 Django 应用程序，在开发过程中由 Django 内置的开发 Web 服务器负责调
度。
❏ 数据库使用基于 Python 的 SQLite3 数据库引擎。
❏ 搜索 API 使用 Webhose API。
本书基本上将集中精力开发中间件，不过从图 1-1 中不难看出，我们也将与其他组件交互。
线框图
线框图可以让客户一览最终完成的应用是什么样子。线框图能节省大量时间，不过具体形式各种
各样，有手绘的，也有使用专用工具的。 Rango 应用首页的设计稿见图 1-2，分类页面的设计稿见
图 1-3。
1.4 Rango 的初步设计和客户要求 - 5图 1-2：首页，左边是分类搜索框，右边是查看次数最多的 5 个分类和 5 个网页
页面和 URL 映射
从客户的要求中我们知道，应用至少要有两个页面。为了能访问各个页面，我们要描述 URL 映
射。你可以把 URL 映射理解为访问页面时在浏览器地址栏中输入的文本。 Rango 应用的基本
URL 映射如下：
❏ / 或 /rango/ 指向主页
❏ /rango/about/ 指向关于页面
❏ /rango/category/<category_name>/ 指向名为 <category_name>（例如 games、 python-recipes
或 code-and-compilers）的分类页面
这只是开始，在构建应用的过程中，可能还要添加其他 URL 映射。本书将带领你使用 Django 框
架和“模型-视图-模板”设计模式逐渐丰富这些页面的内容。对 URL 映射和页面的设计有了大致了
解之后，我们要定义数据模型，存储应用将用到的数据。
6 - 第 1 章 导言图 1-3：分类页面，显示分类中的网页（带有访问次数），以及搜索“Python”得到的结果
实体关系图
根据客户的要求，很明显我们至少需要两个实体：分类（category）和网页（page）。而且，一个
分类中可以有多个网页。这个简单的数据模型可以通过下述 ER 图描述。
注意，这个关系并不十分明确。理论上，一个网页可以归入多个分类。鉴于此，分类和网页之间
可以通过多对多关系建模。但是这样处理太过复杂，因此我们将假定一个分类中有多个网页，而
一个网页只能属于一个分类。这样并不妨碍把一个网页归入不同的分类，只不过要多次输入相同
的网页，不是太理想而已。
1.4 Rango 的初步设计和客户要求 - 7图 1-4： Rango 应用中两个主要实体的 ER 图
根据这一假设，我们可以通过表格列出各实体的详细内容，指明各实体中有哪些字段。我们使用
Django 的 ModelField 类型定义各字段的类型（即 IntegerField、 CharField、 URLField 或
ForeignKey）。注意，在 Django 中主键（primary key）是隐含的， Django 会为各模型添加 id 字
段（详情参见第 5 章）。
表 1-1： Category 模型
字段 类型
name CharField
views IntegerField
likes IntegerField
表 1-2： Page 模型
字段 类型
category ForeignKey
title CharField
url URLField
views IntegerField
此外，还需要一个 User 模型，以便用户注册和登录。这里没有给出 User 模型，讨论用户身份验
证时再介绍。后面的章节将说明如何在 Django 中定义这些模型，以及如何使用内置的 ORM 连接
数据库。
1.5 小结
这些整体上的设计和要求将在构建 Web 应用的过程中为我们提供参考。虽然我们将集中精力说明
如何使用特定的技术，但是多数数据库驱动的网站都是这么规划的。因此，你最好能熟练地阅读
和制定这样的要求和设计，以便与人顺畅沟通。本书将使用 Django 和相关的技术实现这里制定的
要养成习惯，把所做的假设记录下来，例如这里假设的一对多关系，以防以后出问题。有了
记录，你便可以与开发团队沟通，确保他们考虑到了你的假设。
◼ 做好记录 ◼
8 - 第 1 章 导言
图灵社区会员 骆昊(jackfrued@126.com) 专享 尊重版权要求。
阅读本书的过程中，你可能会把书中的代码复制粘贴到代码编辑器中。然而，笔者建议自己
动手输入代码。我们知道自己输入稍显麻烦，但是这样有助于你理解整个过程，还能让你记
住以后用得到的命令。
此外，复制粘贴 Python 代码简直就是自找麻烦。复制的空白可能变成空格、制表符或二者
混杂。这样可能导致各种奇怪的问题，而且不一定是由缩进引起的。如果你确实想复制粘贴
代码，一定要留神这样的问题。如果你使用的是 Python 3，对这样的问题要格外小心，因为
混用制表符和空格缩进会导致 TabError。
多数代码编辑器都能显示空白，而且会区分制表符和空格。如果你使用的编辑器有这样的功
能，一定要启用，免得分不清。
◆ 复制粘贴代码 ◆
1.5 小结 - 92
开始编程之前，我们要搭建好 Django 所需的开发环境。我们要在自己的电脑中安装所需的全部组
件。本章概述要安装和使用的 5 个关键组件。
❏ 终端或命令提示符
❏ Python
❏ Python 包管理器和虚拟环境
❏ 集成开发环境（如果你想用的话）
❏ 版本控制系统 Git
如果你的电脑中已经安装了 Python 2.7/3.4/3.5 和 Django 1.9/1.10，而且熟悉前述工具，可以直接
跳到第 3 章。否则，请阅读下面对这些组件的介绍，以及它们在开发过程中的重要性。我们还将
指出这些组件的安装方式。
2.1 Python
本书要求你在自己的电脑中安装 Python 编程语言， 2.7 系列（至少 2.7.5）或 3.4 版本以上都行。
前期准备工作
搭建开发环境是个繁琐的过程，很容易出错，但不是每天都要做。本章介绍这其中涉及的关
键技术，以及如何安装各个组件。
根据笔者的经验，建议你把搭建的步骤记录下来。说不定有一天你会用到，例如你买了新电
脑，或者帮助别人。现在做的记录能为以后节省时间和精力。不要只看眼前！
★ 开发环境 ★
11如果你不知道如何安装 Python，需要帮助，请阅读 A.1 节。
2.2 Python 包管理器
pip 是 Python 的包管理器。你可以使用 pip 安装各种库，增强 Python 的功能。
包管理器，不管是针对 Python 的、针对操作系统的，还是针对其他环境的，是一种自动安装、升
级、配置和删除包的软件，解放了你的双手，无需你自己动手下载、安装和维护软件。 Python 包
管理起来可不简单。多数包通常有依赖（dependency），要随包一起安装。因此，包之间可能有
冲突，需要依赖特定的版本。此外，包的系统路径也要指定和维护。幸好，这些繁琐的工作都由
pip 代为处理了，解放了我们的生产力。
使用 pip 命令运行 pip 试试看。如果提示找不到 pip 命令，说明你要安装 pip。详情参见附录 A。
你还要确保自己的系统中安装了下面两个包。执行下述命令，安装 Django 和 Pillow（处理图像的
Python 库）：
$ pip install -U django==1.9.10
$ pip install pillow
如果你没用过 Python，或者想提升自己的技能，笔者推荐下面几个材料：
❏ Stavros 写的 Python 10 分钟速成教程
❏ Python 官方教程
❏ Allen B. Downey 写的《像计算机科学家一样思考 Python》
❏ Jennifer Campbell 和 Paul Gries 开设的“学习编程”课程
这几个材料能让你熟悉 Python 的基础知识，以便开始使用 Django 开发应用。注意，为了使
用 Django，你无需变身专家。 Python 是门优秀的语言，如果你会用其他编程语言，可以边
用边学。
★ 不会用 Python？ ★
安装 Pillow 时可能会报错，提示缺少 JPEG 支持，如下所示：
◼ 无法成功安装 Pillow？ ◼
